# Automatic Access Token Refresh via Cron Job

To ensure uninterrupted access to Google APIs, an automated system has been implemented to refresh user access tokens before they expire.

### Key Components:

-   **Token Refresh Logic (`services/jobsService.js`):**
    -   A new service was created to handle the logic for identifying and refreshing expiring access tokens.
    -   It finds users whose `accessTokenExpiresAt` is within a 10-minute threshold of expiring.
    -   For each of these users, it uses their `refreshToken` to request a new `accessToken` from Google's OAuth 2.0 service.
    -   The user's record in the database is then updated with the new `accessToken` and its corresponding `accessTokenExpiresAt`.

-   **Cron Job Scheduler (`utils/jobs.js`):**
    -   The `node-cron` library has been integrated to schedule a recurring job.
    -   The job is configured to run every minute (`*/1 * * * *`) to execute the token refresh logic.
    -   This ensures that tokens are proactively refreshed, preventing API access issues due to expired tokens.

-   **Database Schema Update (`models/User.js`):**
    -   The `User` model has been updated to include a new field: `accessTokenExpiresAt`. This field stores the expiry date of the Google OAuth access token, which is crucial for the cron job to identify which tokens need refreshing.

-   **Server Integration (`server.js`):**
    -   The cron job defined in `utils/jobs.js` is now imported into the main `server.js` file, which ensures the job starts when the server starts.

### How it Works:

1.  When a user authenticates, the application now stores not only their access and refresh tokens but also the expiry date of the access token (`accessTokenExpiresAt`).
2.  A cron job runs every 30 Min in the background.
3.  The job queries the database for users whose access tokens will expire in the next 10 minutes.
4.  For each user found, it uses their refresh token to obtain a new access token from Google.
5.  The new token and its expiry time are saved back to the user's record in the database.

This automated process ensures the application maintains persistent and valid access to the Gmail API on behalf of its users, which is essential for the application's core functionality.
