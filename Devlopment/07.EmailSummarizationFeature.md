# ğŸ“Œ Velora â€“ Email Summarization (VEL-31) â€” KT Summary

### ğŸ”„ High-level Flow

1. **Gmail Watch + Pub/Sub** â†’ webhook `/gmail/notifications` â†’ extracts notification â†’ fetches new emails.
2. **Store Emails** â†’ normalized into `Email` docs (`toSummarize: true`, `isSummarized: false`).
3. **Cron Summarization** â†’ picks pending emails â†’ decrypts â†’ calls n8n summarizer â†’ stores in `SummarizedEmail` â†’ marks `Email.isSummarized = true`.

---

### ğŸ— Gmail Summarizer Components

* **gmailService**: starts watch, extracts Pub/Sub, updates history, fetches emails.
* **gmailController**: handles notifications â†’ triggers fetch.
* **jobsMailService**: fetch pending â†’ decrypt â†’ summarize via n8n â†’ encrypt + store summaries.

---

### ğŸ”— n8n Integration

* **Endpoint**: `${N8N_BASE_URL}/mail-summarizer` (POST, JWT Auth).
* **Request**: array of emails (decrypted).
* **Response**: array of summaries (`gmailMessageId`, `summary`, `explaination`).

---

### â° Cron Jobs (Related to Summarization)

* **Summarize pending emails** â†’ every 20s.
* **Refresh tokens** â†’ every 25 mins (to ensure summarization can call Gmail APIs).
* **Restart Gmail watch** â†’ daily at midnight (ensures continued delivery of new email notifications).

---

### âš¡ Operational Notes

* Monitor summarization loop and ensure n8n webhook is responsive.
* Tune summarization interval (20s) based on system and n8n load.
* If backlog grows, consider batching or scaling summarizer workers.
