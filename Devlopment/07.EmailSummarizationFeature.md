# 📌 Velora – Email Summarization (VEL-31) — KT Summary

### 🔄 High-level Flow

1. **Gmail Watch + Pub/Sub** → webhook `/gmail/notifications` → extracts notification → fetches new emails.
2. **Store Emails** → normalized into `Email` docs (`toSummarize: true`, `isSummarized: false`).
3. **Cron Summarization** → picks pending emails → decrypts → calls n8n summarizer → stores in `SummarizedEmail` → marks `Email.isSummarized = true`.

---

### 🏗 Gmail Summarizer Components

* **gmailService**: starts watch, extracts Pub/Sub, updates history, fetches emails.
* **gmailController**: handles notifications → triggers fetch.
* **jobsMailService**: fetch pending → decrypt → summarize via n8n → encrypt + store summaries.

---

### 🔗 n8n Integration

* **Endpoint**: `${N8N_BASE_URL}/mail-summarizer` (POST, JWT Auth).
* **Request**: array of emails (decrypted).
* **Response**: array of summaries (`gmailMessageId`, `summary`, `explaination`).

---

### ⏰ Cron Jobs (Related to Summarization)

* **Summarize pending emails** → every 20s.
* **Refresh tokens** → every 25 mins (to ensure summarization can call Gmail APIs).
* **Restart Gmail watch** → daily at midnight (ensures continued delivery of new email notifications).

---

### ⚡ Operational Notes

* Monitor summarization loop and ensure n8n webhook is responsive.
* Tune summarization interval (20s) based on system and n8n load.
* If backlog grows, consider batching or scaling summarizer workers.
