# ðŸ“¬ Gmail Push Notifications via Google Cloud â€“ Setup & Implementation Guide

This document outlines the **architecture**, **configuration**, and **integration process** I used to implement Gmail push notifications in my project.
It is based on the [Medium article by Eagnir](https://medium.com/@eagnir/understanding-gmails-push-notifications-via-google-cloud-pub-sub-3a002f9350ef) with additional practical implementation details from my own experience.

---

## 1. Enable Gmail API in Google Cloud

**What I did:**

* Opened **Google Cloud Console** â†’ **APIs & Services** â†’ **Library**.
* Searched for **Gmail API** and enabled it for my project.
* Verified that **Pub/Sub API** was also enabled (required for push notifications).

---

## 2. Create OAuth 2.0 Credentials

**What I did:**

* In **APIs & Services â†’ Credentials**, created an **OAuth 2.0 Client ID**.
* Set application type to **Web Application**.
* Added redirect URIs for my backend OAuth flow:

  ```
  https://myapp.com/auth/google/callback
  ```
* Configured the **OAuth consent screen** (app name, scopes, test users).
* Downloaded the `credentials.json` file.

---

## 3. Set Up Pub/Sub Topic

**What I did:**

* In **Pub/Sub â†’ Topics**, created:

  * Topic: `Gmail-Watch-topic`
  * Subscription: `Gmail-Watch-sub`
* Chose **Push** delivery with endpoint:

  ```
  https://myapp.com/gmail/notifications
  ```
* Enabled authentication via service account.

---

## 4. Configure Gmail Watch Request

**What I did:**

* After user OAuth, called:

  ```js
  gmail.users.watch({
    userId: 'me',
    requestBody: {
      topicName: 'projects/velora-dev-1907/topics/Gmail-Watch-topic',
      labelIds: ['INBOX'],
      labelFilterAction: 'include'
    }
  });
  ```
* Stored returned `historyId` and `expiration` in DB.

---

## 5. Implement Notification Listener

**What I did:**

* Created `/gmail/notifications` endpoint in **Express**.
* Verified Google headers and decoded **base64** data:

  ```js
  const decodedData = Buffer.from(req.body.message.data, 'base64').toString('utf8');
  const { emailAddress, historyId } = JSON.parse(decodedData);
  ```
* Logged received data for debugging.

---

## 6. Handle Gmail API Authorization

**What I did:**

* Implemented OAuth 2.0 login using `passport-google-oauth20`.
* Stored `access_token` and `refresh_token` in MongoDB.
* Used `googleapis` library for token refresh.

---

## 7. Fetch Email Changes from History API

**What I did:**

* On push notification:

  1. Read `lastHistoryId` from DB.
  2. Called:

     ```js
     gmail.users.history.list({
       userId: 'me',
       startHistoryId: lastHistoryId,
       historyTypes: ['messageAdded']
     });
     ```
  3. For each new message, called `gmail.users.messages.get`.
  4. Saved relevant email data in MongoDB.
  5. Updated `lastHistoryId`.

---

## 8. Renew the Watch Periodically

**What I did:**

* Created cron job to re-send watch requests before expiration.
* If `404: HistoryId too old`, performed full mailbox sync.

---

## 9. Testing the Integration

**What I did:**

* Sent test emails to authorized account.
* Verified:

  * Pub/Sub â†’ `/gmail/notifications` received.
  * History API fetched new messages.
  * DB updated with correct metadata.

---

## 10. Monitoring & Maintenance

**What I did:**

* Added logs for:

  * Pub/Sub notifications.
  * Base64 decoding.
  * History API calls.
  * DB saves.
* Monitored errors & retries for failures.

---

## Notes

* **Billing** must be enabled for Pub/Sub.
* OAuth & service account keys stored securely.
* Push endpoint must have **valid HTTPS**.
* Each user must complete OAuth separately.

---
